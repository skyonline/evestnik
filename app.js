/*6174f7e5afcd70cb3ab1a406d1dacb9c0fd21a97*/Ext.define("Judge.view.Articles",{id:"ArticlesView",extend:"Ext.dataview.NestedList",xtype:"articles",requires:["Ext.carousel.Carousel"],config:{title:"Статьи",iconCls:"star",listConfig:{itemTpl:'<div class="judge-list-item"><tpl if="img"><img src="{img}"/></tpl><h4>{title}</h4><small>{description}</small></div>'},updateTitleText:false,detailCard:{xtype:"carousel",scrollable:true,styleHtmlContent:true}}});Ext.define("Judge.view.About",{id:"AboutView",extend:"Ext.dataview.NestedList",xtype:"about",config:{title:"Информация",iconCls:"info",listConfig:{itemTpl:'<div class="judge-list-item"><tpl if="img"><img src="{img}"/></tpl><h4>{title}</h4><small>{description}</small></div>'},detailCard:{xtype:"container",scrollable:true,styleHtmlContent:true}}});Ext.define("Judge.view.NewsList",{extend:"Ext.dataview.NestedList",xtype:"newslist",id:"newsList",requires:["Ext.carousel.Carousel"],config:{title:"Новости",iconCls:"time",listConfig:{itemTpl:'<div class="judge-list-item"><tpl if="img"><img src="{img}"/></tpl><h4>{title}</h4><small>{description}</small></div>'},updateTitleText:false,detailCard:{xtype:"carousel",scrollable:true,styleHtmlContent:true}}});Ext.define("Judge.model.LoginModel",{extend:"Ext.data.Model",config:{fields:["name","password","uniqkey"]}});Ext.define("Judge.view.Login",{extend:"Ext.Container",id:"LoginPanel",xtype:"login",requires:["Ext.TitleBar","Ext.form.FieldSet","Ext.field.Email","Ext.field.Password","Judge.model.LoginModel"],config:{title:"Вход",scrollable:true,items:[{xtype:"fieldset",title:"Вход",instructions:"Для входа в систему введите логин и пароль, и нажмите вход",items:[{xtype:"emailfield",label:"Логин",placeHolder:"email@example.com",name:"email",required:true,id:"txtEmail"}]},{xtype:"container",layout:"hbox",items:[{xtype:"button",text:"Вход",ui:"confirm",flex:1,id:"btnSubmit"},{xtype:"spacer",flex:1},{xtype:"button",text:"Отмена",flex:1,id:"btnCancel"}]}]}});Ext.define("Judge.view.Register",{extend:"Ext.Container",id:"RegisterPanel",xtype:"register",requires:["Ext.TitleBar","Ext.form.FieldSet","Ext.field.Email","Ext.field.Password","Judge.model.LoginModel"],config:{title:"Регистрация",scrollable:true,items:[{xtype:"fieldset",title:"Регистрация",instructions:"Для входа в систему введите логин и пароль, и нажмите вход",items:[{xtype:"emailfield",label:"Логин",placeHolder:"email@example.com",name:"regEmail",required:true,id:"txtRegEmail"},{xtype:"textfield",label:"Имя",name:"regName",required:true,id:"txtRegName"},{xtype:"numberfield",label:"Телефон",name:"regPhone",required:true,id:"txtRegPhone"}]},{xtype:"container",layout:"hbox",items:[{xtype:"button",text:"Регистрация",ui:"confirm",flex:1,id:"btnRegister"},{xtype:"spacer",flex:1},{xtype:"button",text:"Отмена",flex:1,id:"btnRegisterCancel"}]}]}});Ext.define("Judge.view.MagazinesAvailableList",{extend:"Ext.dataview.List",xtype:"availablelist",id:"AvailableList",config:{title:"Доступные",itemTpl:'<div class="judge-list-item"><tpl if="img"><img src="{img}"/></tpl><h4>{title}</h4><small>{description}</small></div>',items:[{xtype:"titlebar",docked:"top",title:"Доступные",ui:"light"}]}});Ext.define("Judge.view.MagazinesDownloadedList",{extend:"Ext.dataview.NestedList",xtype:"downloadedlist",id:"DownloadedList",config:{title:"Скачанные",displayField:"title",detailCard:{xtype:"container",scrollable:true,styleHtmlContent:true}}});Ext.define("Judge.model.EntryModel",{extend:"Ext.data.Model",config:{fields:["id","title","headline","content"],proxy:{type:"ajax",url:"http://evestnik.sib.by/export.html",reader:{type:"json"}}}});Ext.define("Judge.model.ListModel",{extend:"Ext.data.Model",config:{fields:["id","pagetitle","description","img","content","data"],hasMany:{model:"Judge.model.ListItemModel",name:"data"},proxy:{type:"ajax",url:"http://evestnik.sib.by/export.html",reader:{type:"json"}}}});Ext.define("Judge.model.ListItemModel",{extend:"Ext.data.Model",config:{fields:["id","title","description","img","content","leaf","list"],belongsTo:"Judge.model.ListModel",hasMany:{model:"Judge.model.ListItemModel",name:"list"}}});Ext.define("Judge.controller.LoginController",{extend:Ext.app.Controller,requires:["Judge.model.LoginModel"],config:{refs:{panelMagazine:"#magazinePanel",btnSubmit:"#btnSubmit",btnCancel:"#btnCancel",txtEmail:"#txtEmail",btnRegister:"#btnRegister",btnRegisterCancel:"#btnRegisterCancel",txtRegEmail:"#txtRegEmail",txtRegName:"#txtRegName",txtRegPhone:"#txtRegPhone"},control:{btnSubmit:{tap:"onSubmit"},btnCancel:{tap:"onCancel"},btnRegister:{tap:"onRegister"},btnRegisterCancel:{tap:"onRegisterCancel"}}},onSubmit:function(){var a=this;if(navigator.network&&navigator.network.connection&&navigator.network.connection.type!=Connection.NONE){Ext.Ajax.request({url:"http://evestnik.sib.by/user.html",method:"POST",params:{email:this.getTxtEmail().getValue(),key:"abc"},success:function(b){var c=a.getApplication().getController("MagazinesListController");c.loggedIn=true;c.loadData();a.getPanelMagazine().setActiveItem(1)},failure:function(){alert("Вход невозможен. Ошибка подключения.")}})}else{alert("Вход невозможен. Отсутствует подключение к интернету.")}},onCancel:function(){this.getPanelMagazine().setActiveItem(1)},onRegister:function(){var a=this;if(navigator.network&&navigator.network.connection&&navigator.network.connection.type!=Connection.NONE){Ext.Ajax.request({url:"http://evestnik.sib.by/reg.html",method:"POST",params:{email:this.getTxtRegEmail().getValue(),user:this.getTxtRegEmail().getValue(),name:this.getTxtRegName().getValue(),phone:this.getTxtRegPhone().getValue(),key:device.uuid},success:function(b){alert("Регистрация прошла успешно. Ожидайте активации аккаунта.");a.getPanelMagazine().setActiveItem(1)},failure:function(){alert("Вход невозможен. Ошибка подключения.")}})}else{alert("Вход невозможен. Отсутствует подключение к интернету.")}},onRegisterCancel:function(){this.getPanelMagazine().setActiveItem(1)}});Ext.define("Judge.view.Magazine",{extend:"Ext.Container",xtype:"magazines",requires:["Judge.view.Login","Judge.view.Register","Judge.view.MagazinesAvailableList","Judge.view.MagazinesDownloadedList"],id:"magazinePanel",config:{layout:"card",title:"Журнал",iconCls:"bookmarks",items:[{xtype:"tabpanel",tabBarPosition:"top",items:[{xtype:"login"},{xtype:"register"}]},{xtype:"tabpanel",tabBarPosition:"top",items:[{xtype:"availablelist"},{xtype:"downloadedlist"}]}]}});Ext.define("Judge.view.Main",{id:"MainView",extend:"Ext.tab.Panel",requires:["Judge.view.Articles","Judge.view.Magazine","Judge.view.About","Judge.view.NewsList"],fullscreen:true,config:{tabBarPosition:"bottom",items:[{xtype:"articles"},{xtype:"newslist"},{xtype:"magazines"},{xtype:"about"}]}});Ext.define("Judge.controller.ListBaseController",{extend:"Ext.app.Controller",requires:["Judge.model.EntryModel","Judge.model.ListModel","Judge.model.ListItemModel"],config:{refs:{listView:""},control:{listView:{itemtap:"onItemTap"}}},listModelId:undefined,getDetailsCardContent:function(a){return a.data.content},postLaunch:function(b,a){},buildStore:function(b,a){b.setStore(Ext.create("Ext.data.TreeStore",{model:"Judge.model.ListItemModel",defaultRootProperty:"list",root:{list:a,leaf:false}}))},launch:function(){this.callParent(arguments);this.loadData()},loadData:function(){var b=this.getListView();var c=this.listModelId;if(!c){throw"You should specify you model id in derrived class to retrive appropriate data from service!"}var a=this;this.loadModel("Judge.model.ListModel",c,function(d){a.processProperties(d.data.data);a.buildStore(b,d.data.data);a.on({postLaunch:a.postLaunch});a.fireEvent("postLaunch",b,d.data.data)})},processProperties:function(b){var a=this;Ext.each(b,function(e,d,f){if(f[d].id){f[d].leaf=(f[d].leaf=="1");var c=f[d].list;if(c){a.processProperties(c)}}else{Ext.Array.remove(f,e)}})},loadModel:function(b,d,a){if(navigator.network&&navigator.network.connection&&navigator.network.connection.type!=Connection.NONE){try{Ext.ModelMgr.getModel(b).load(d,{success:a,failure:function(){alert("Произошла ошибка загрузки данных. Повторите попытку позже.")}})}catch(c){alert("Ошибка загрузки данных. Повторите попытку позже.")}finally{}}},onItemTap:function(h,g,a,c,b){if(b.get("leaf")==true){var f=h.getDetailCard();var e=b.get("id");var d=this;this.loadModel("Judge.model.EntryModel",e,function(i){f.setHtml(d.getDetailsCardContent(i))})}}});Ext.define("Judge.controller.AboutController",{extend:"Judge.controller.ListBaseController",config:{refs:{listView:"#AboutView"}},listModelId:176});Ext.define("Judge.controller.MagazinesListController",{extend:"Judge.controller.ListBaseController",config:{refs:{listView:"#AvailableList",downloadedListView:"#DownloadedList"},control:{listView:{itemtap:"onAvailableTap"}}},listModelId:179,loggedIn:false,loadModel:function(b,c,a){if(this.loggedIn==true){this.callParent(arguments)}},buildStore:function(c,b){if(window.LocalFileSystem){window.requestFileSystem(LocalFileSystem.PERSISTENT,0,a,null);function a(d){d.root.getDirectory("magazines",{create:true,exclusive:false},e,null);function e(f){var g=f.createReader();g.readEntries(h,null);function h(i){var j=[];Ext.each(b,function(l){var k=true;Ext.each(i,function(m){if(m.isFile){if(l.id+".txt"==m.name){k=false;return false}}});if(k==true){j.push(l)}});c.setStore(Ext.create("Ext.data.Store",{model:"Judge.model.ListItemModel",data:j}))}}}}else{c.setStore(Ext.create("Ext.data.Store",{model:"Judge.model.ListItemModel",data:b}))}},onAvailableTap:function(c,d,f,b,e){if(navigator.network&&navigator.network.connection&&navigator.network.connection.type!=Connection.NONE){var h=b.get("id");var a=this;var g={};Ext.Ajax.request({url:"http://evestnik.sib.by/export.html",urlParams:{id:h},success:function(i){object=JSON.parse(i.responseText);var l=undefined;function k(){alert("Невозможно сохранить журнал. Убедитесь в наличии свободного места.")}window.requestFileSystem(LocalFileSystem.PERSISTENT,0,j,k);function j(n){n.root.getDirectory("magazines",{create:true,exclusive:false},o,k);function o(p){p.getFile(h+".txt",{create:true,exclusive:false},m,k)}function m(q){q.createWriter(p,k);function p(r){r.onwriteend=function(s){var t=a.getListView().getStore();t.data.each(function(u){if(u.get("id")==object.id){t.remove(u)}});object.title=object.pagetitle;object.list=object.data;object.data=null;a.processProperties(object.list);a.getDownloadedListView().getStore().getRoot().appendChild(object)};r.write(object)}}}},failure:function(){alert("Невозможно скачать журнал. Проверьте подключение к интернету.")}})}else{alert("Невозможно скачать журнал. Отсутствует подключение к интернету.")}}});Ext.define("Judge.controller.MagazinesDownloadedController",{extend:"Judge.controller.ListBaseController",config:{refs:{listView:"#DownloadedList"},control:{listView:{itemtap:"onItemTap"}}},listModelId:{},modelReader:null,launch:function(){var d=this.getListView();var c=this;d.setStore(Ext.create("Ext.data.TreeStore",{model:"Judge.model.ListItemModel",defaultRootProperty:"list",root:{list:[],leaf:false},proxy:{type:"memory",reader:{type:"json",root:"list"}}}));if(window.LocalFileSystem){function a(){alert(GlobalMessages.FileSystemError)}window.requestFileSystem(window.LocalFileSystem.PERSISTENT,0,b,a);function b(e){e.root.getDirectory("magazines",{create:true,exclusive:false},f,a);function f(g){var h=g.createReader();h.readEntries(i,a);function i(j){Ext.each(j,function(m,l){if(m.isFile){var k=new FileReader();k.onloadend=function(n){var o=JSON.parse(n.target.result);o.title=o.pagetitle;o.list=o.data;o.data=null;c.processProperties(o.list);d.getStore().getRoot().appendChild(o)};k.readAsText(m)}})}}}}else{}},onItemTap:function(e,d,a,c,b){if(b.get("leaf")==true){e.getDetailCard().setHtml(b.get("content"))}}});Ext.define("Judge.controller.ListCarouselController",{extend:"Judge.controller.ListBaseController",config:{refs:{listView:""},control:{listView:{itemtap:"onItemTap"}}},onCarouselIndexChange:function(a,e,b,c){if(e.getHtml()==""){var d=this;var f=e.getId();this.loadModel("Judge.model.EntryModel",f,function(g){e.setHtml(d.getDetailsCardContent(g))})}},postLaunch:function(e,a){if(a){var d=e.getDetailCard();var c=this;d.on({activeitemchange:c.onCarouselIndexChange,scope:this});for(var b=0;b<a.length;b++){d.insert(b,{xtype:"container",layout:"card",html:"",id:a[b].id})}}},onItemTap:function(a,f,e,b,h){if(h.get("leaf")==true){var i=a.getDetailCard();var c=i.getItems().items[e];if(c.getHtml()==""){var g=h.get("id");var d=this;this.loadModel("Judge.model.EntryModel",g,function(j){c.setHtml(d.getDetailsCardContent(j));i.setActiveItem(e)})}else{i.setActiveItem(e)}}}});Ext.define("Judge.controller.NewsController",{extend:"Judge.controller.ListCarouselController",config:{refs:{listView:"#newsList",xtype:"newslist",autoCreate:true}},listModelId:174});Ext.define("Judge.controller.ArticlesController",{extend:"Judge.controller.ListCarouselController",config:{refs:{listView:"#ArticlesView",xtype:"articles",autoCreate:true}},listModelId:175});Ext.Loader.setPath({Ext:"sdk/src"});Ext.application({name:"Judge",icon:{"57":"resources/icons/Icon.png","72":"resources/icons/Icon~ipad.png","114":"resources/icons/Icon@2x.png","144":"resources/icons/Icon~ipad@2x.png"},isIconPrecomposed:true,startupImage:{"320x460":"resources/startup/320x460.jpg","640x920":"resources/startup/640x920.png","768x1004":"resources/startup/768x1004.png","748x1024":"resources/startup/748x1024.png","1536x2008":"resources/startup/1536x2008.png","1496x2048":"resources/startup/1496x2048.png"},views:["Main"],controllers:["NewsController","ArticlesController","LoginController","AboutController","MagazinesListController","MagazinesDownloadedController"],phoneStartupScreen:"resources/loading/Homescreen.jpg",tabletStartupScreen:"resources/loading/Homescreen~ipad.jpg",launch:function(){Ext.fly("appLoadingIndicator").destroy();if(navigator.network&&navigator.network.connection){if(navigator.network.connection.type==Connection.NONE){alert(GlobalMessages.NoInetOfflineMode)}else{var a=Ext.create("Ext.LoadMask",{message:GlobalMessages.LoadingData});Ext.Viewport.add(a);Ext.Ajax.on("beforerequest",function(){a.show()});Ext.Ajax.on("requestcomplete",function(){a.hide()});Ext.Ajax.on("requestexception",function(){a.hide()})}}Ext.Viewport.add(Ext.create("Judge.view.Main"))},onUpdated:function(){window.location.reload()}});